<!-- Author: Tina Vo -->
<!-- Date: 11/18/2021 -->
<!-- Invoice Page -->

<!--load product_data.js to generate the invoice receipt, get request for products_array-->
<!--note: product_data.js was used before to test, no longer needed because of .json-->
<script src="./product_data.js" type="text/javascript"></script>

<script>

  let params = (new URL(document.location)).searchParams; // stop user from going to the invoice if not logged in
  if (params.has('username') == false) { // check if user is logged in or registered
    alert('Please log in or register first!');
    location.href = './products_display.html'; //redirect to products_display after alert message
    window.stop;
  }

  var quantities = [];
  var user_data = './user_data.json';
  // process invoice after submit

  // invoice loads after valid quantity is inserted
  if (params.has('checkout_button')) { //searches and gets the checkout button 
    for (i = 0; i < products_array.length; i++) {
      if (params.has(`quantity${i}`)) {
        execute_quantity = params.get(`quantity${i}`);
        quantities[i] = execute_quantity;
      }
    }
  } else {
    document.write('invalid form'); // error msg when form is accessed without submission
  }
  console.log(quantities);
</script>

<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>Receipt</title>
  <link href="./invoice.css" rel="stylesheet">

</head>

<body>
  <!--div box for text-->
  <div id="topText">
    <h2 id="subtitle">Order Confirmation</h2>
  </div>
  <br>
<!--personalization: thank buyer with their name and email-->
<b></b><h2 id="personal_thanks">Thank you
  <script>
    document.write(params.get('name')); 
  </script>
  for your order!
</h2>

<h2 id="personal_thanks">Your receipt has been sent to
  <script>
    document.write(params.get('email'));
  </script>.
</h2>

  <!--table for the invoice-->
  <table>
    <tbody>
      <tr>
        <th style="text-align: center;" width="20%">Image</th>
        <th style="text-align: center;" width="11%">Product</th>
        <th style="text-align: center;" width="11%">Quantity</th>
        <th style="text-align: center;" width="11%">Price</th>
        
      </tr>
      <script>
        //generate rows by using a for loop
        //initialize the subtotal to zero (beginning)
        subtotal = 0;

        //set up conditionals
        for (i = 0; i < products_array.length; i++) {
          if (quantities[i] > 0) {
            extended_price = quantities[i] * products_array[i].price
            subtotal += extended_price;
            document.write(`
          
      <tr>
        <td width="23%"><center><img src="${products_array[i].image}" style="width:120px; height:auto;"></center></td>
        <td width="11%"><center>${products_array[i].name}</center></td>
        <td align="center" width="11%">${quantities[i]}</td>
        <td width="11%"><center>\$${products_array[i].price}</center></td>
       
      </tr>
      `);
          }
        }
        //based on invoice4 but altered according to business
        //compute tax
        var taxRate = 0.427; // this is the local sales tax 
        
        // compute shipping
        // subtotals up to $50 will have $4 shipping
        if (subtotal <= 30) {
          shipping = 4.50;

        }

        // subtotals over $30 get free shipping
        else if (subtotal >= 31) {
          shipping = 0;

        }

        //compute total 
        var total = taxRate + subtotal + shipping;

       

        //calculations displayed here with two decimal places
        document.write(`
        <tr>
          <td colspan="3" width="50%">&nbsp;</td>
        </tr>
        <tr>
          <td>Subtotal</td>
          <td>$${subtotal.toFixed(2)}</td>
        </tr>
        <tr>
          <td>Tax @ 4.27%</td>
          <td>$${taxRate.toFixed(2)}</td>
        </tr>
        <tr>
          <td>Shipping</td>
          <td>$${shipping.toFixed(2)}</td>
        </tr>
        <tr>
          <td><b>Grand Total</b></td>
          <td><b>$${total.toFixed(2)}</b></td>
        </tr>
        `);

      </script>
    </tbody>
  </table>
  
<br>

<br>If you have any questions, concerns, or want to share your thoughts, 
  <br>email us at <a href = "mailto: tinavo@hawaii.edu">tinavo@hawaii.edu</a>
  <br>
  <br>
  <!--back button to products display-->
  <input type="button" class="button" value="Home" id="back_home"
    onclick="window.location.href = 'products_display.html';">

  <br>

  


  <!--shipping information-->
  <section class="return_policy">
    <b><br>General Shipment<br></b>
    <br>Tina's Stationery ships all orders within the US at a rate of $4.50 per order.
    <br>We provide free shipping for purchases over $30!
    <br>
    <br>Â© 2021 Tina's Stationery
  </section>

  <script>
    //display alert as a response when for loops from server.js are executed depending on the quantity inserted
    window.onload = function () {
      let params = (new URL(document.location)).searchParams;
      //if errorMessage is in qry string then put up alert with error message
      if (params.has("loginMessage")) {
        alert(params.get("loginMessage"));


      }
    }

  </script>

</body>

</html>