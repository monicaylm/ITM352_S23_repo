<!--- Description 
Author: Zenan Li & Kai Lin
Date: May 13, 2022
Description: This is the page to display the products and quantity available which can differ based on the types of products the user wants to buy. It allows them to select amounts and add it to a shopping cart. They can also the average star rating of each of products

 // The following web page layout is taken from the W3Schools at https://www.w3schools.com/bootstrap/tryit.asp?filename=trybs_temp_store&stacked=h
----->

<!DOCTYPE html>
<html lang="en">
<head>
  <title>Products Display</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js"></script>
  <link rel="stylesheet" href="./store_style.css">
  <style>
    /* Remove the navbar's default rounded borders and increase the bottom margin */ 
    .navbar {
      margin-bottom: 50px;
      border-radius: 0;
      overflow: hidden;
      font-family: Arial, Helvetica, sans-serif;
    }

    .navbar a {
    float: left;
    color: white;
    text-align: center;
    text-decoration: none;
    }
    
    /* Remove the jumbotron's default bottom margin */ 
    .jumbotron {
      margin-bottom: 0;
    }
   
    /* Add a gray background color and some padding to the footer */
    footer {
      background-color: #f2f2f2;
      padding: 25px;
    }
    /*  Styling for the rating stars on the table. This styling code was borrowed and edited from https://stackoverflow.com/questions/53240610/how-to-make-simple-star-rating */
    .stars s:hover,
    .stars s.active {
      color: yellow;
    }

    .star-rating-rtl s:hover,
    .star-rating-rtl s.active {
      color: yellow;
    }
    .star-rating-rtl {
    background: rgb(0, 0, 0);
    display: inline-block;
    }
  .star-rating-rtl s {
    color: yellow;
  } 
    .star-rating s,
    .star-rating-rtl s {
      color: rgb(249, 220, 59);
      font-size: 40px;
      cursor: default;
      text-decoration: none;
      line-height: 40px;
      text-align: center;
    }

    .star-rating s.rated:before,
    .star-rating s.active:before {
        content: "\2605";
    }
    .star-rating s:before {
        content: "\2606";
    }
    .star-rating-rtl s.rated:after,
    .star-rating-rtl s.active:after {
        content: "\2605";
    }

    .star-rating-rtl s:after {
        content: "\2606";
    }
  
    .show {
    display: block;
    }
  </style>

  <script>
    let params = (new URL(document.location)).searchParams;
    window.onload = () => {
        //Attach quantity in the query string
        if (params.has('quantity')) {
          var quantities = JSON.parse(params.get('quantity'));
          for(i in quantities){
            product_order['quantity'].value = quantities[i];
        }
      }   
    } 
    //Attaches error message in the query string
    if (params.has('error_string')) {
      var errors = JSON.parse(params.get('errors'))
      let error_string = '';
      for(err in errors) {
			  error_string += errors[err] + '\n';
		  }
      alert(params.get('error_string'))
      params.delete('error_string');
    }
  </script>
</head>

<script src="./functions.js"></script> 
<script>
  // get the query string
  if (params.has('products_key')) {
    var this_product_key = params.get('products_key');
  } else {
    document.write('no products key in query string');
    document.stop;
  }
  //Variable for Nav Bar
  var products_array;
  loadJSON('get_products_data', function(response) {
    // Parsing JSON string into object
    products_array = JSON.parse(response);
  });

  //Variable for the User Info to display user's name
  var uinfo;
  loadJSON('get_user_info', function(response) {
    // Parsing JSON string into object
    uinfo = JSON.parse(response);
  });

  //Variable for the # of total items in cart
  var cart_amount;
    loadJSON('./get_cart_data', function (response) {
        // Parsing JSON string into object
        cart_amount = JSON.parse(response);
    });
</script>

<body>
<div class="jumbotron">
  <div class="container1 - text-center">
    <h1>Zenan's Sport's Shop</h1>      
    <p>Mission, Vision & Values</p>
  </div>
</div>

<!-- Start of the Nav Bar-->
<nav class="navbar navbar-inverse">
  <div class="container-fluid1">
    <div class="collapse navbar-collapse" id="myNavbar">
      <ul class="nav navbar-nav">
        <li><a href="index.html">Home</a></li>
        <li>
          <!-- Displays the different products pages-->
          <script>
            nav_bar(this_product_key, products_array);
          </script>
        </li>
        <li><a href="contact.html">Contact</a></li>
      </ul>
      <ul class="nav navbar-nav navbar-right">
         <!--Displays Sign in page if the user is logged in or logout button with their name is signed in -->
        <script id = "Signin_Button">
          if (uinfo.username == "Your Account") {
            document.write(`<li><a href="login.html"><span class="glyphicon glyphicon-user"></span>Sign In</a></li>`)
          }
          else {
            document.write(`<li><a href="/logout"><span class="glyphicon glyphicon-user"></span>Logout ${uinfo.username}</a></li>`);
          }
        </script>
        <li><a href="update.html"><span class="glyphicon glyphicon-user"></span>Update Acccount</a></li>
        <li><a href="register.html"><span class="glyphicon glyphicon-user"></span>Register</a></li>
         <!-- Links to the shopping cart page but also displays a shopping cat image with total number of items in the cart -->
        <li><a href="invoice.html"><span class="glyphicon glyphicon-shopping-cart"></span>Cart(<script>document.write(cart_total(cart_amount))</script>)</a>)
        
      </ul>
    </div>
  </div>
</nav>

<!--AUTO LOGOUT

<script>
  //
  if (typeof "Sign In" in "Signin_Button" == false) {
        var t; 
        //window.onload = resetTimer;
        window.onmousemove = resetTimer; // catches mouse movements
        window.onmousedown = resetTimer; // catches mouse movements
        window.onclick = resetTimer;     // catches mouse clicks
        window.onscroll = resetTimer;    // catches scrolling
        window.onkeypress = resetTimer;  //catches keyboard actions
    
        function logout() {
            window.location.href = '/logout';  //Adapt to actual logout script
        }
    
       function reload() {
              window.location = self.location.href;  //Reloads the current page
       }
    
       function resetTimer() {
            clearTimeout(t);
            t = setTimeout(logout, 10000);  // time is in milliseconds (1000 is 1 second)
            t= setTimeout(reload, 300000);  // time is in milliseconds (1000 is 1 second)
        }
    
    idleTimer();
  }

    </script>

    -->
  

<script>
  // Taken and modified from lab12, exercise 5
  // This function serves to determine whether an entry of quantity is a number and a nonnegative integer before this input quantity gets generated on the invoice.
  function IsNonNegInt(q, returnErrors = false) {
    var errors = [];
    if (q == "") {
      q = 0
    }
    else if (Number(q) != q) {
      errors.push('<font color="red"><h4><b>Not a number!</h4></b></font>');
    }// Check if string is a number value.
    else if (q < 0) {
      errors.push('<font color="red"><h4><b>Negative value!</b></h4></font>'); 
    }// Check if it is non-negative.
    else if (parseInt(q) != q) {
      errors.push('<font color="red"><h4><b>Not an integer!</b></h4></font>'); 
    }// Check if it is an integer.
    return (returnErrors ? errors : (errors.length == 0));
  };

  // theTextbox -- The input value inside the quantity textbox that is being tested
  // Taken and modified from lab11, exercise 5
  // This function serves to validate and then respond accordingly to input values in theTextbox.
  function checkQuantityTextbox(theTextbox) {
  var errs = IsNonNegInt(theTextbox.value, true); 
    if (errs.length == 0) {
      errs = ['<h4><b>You want:</b></h4>'];//If there is a valid entry of quantity in the textbox, then display 'You want:' next to the textbox.
    } else if (theTextbox.value.trim() =='') {
      errs = ['<h4><b>Quantity:</b></h4>'];
    }//If there is no entry of quantity in the textbox, then 'Quantity:' remains next to the textbox.
      document.getElementById(theTextbox.name + '_label').innerHTML = errs.join(", ");
  };

  window.onload = function () {
    let params = (new URL(document.location)).searchParams; //Get the query string which has the form data
    if (params.has('purchase_submit')) {
      stock_error = false; 
      has_errors = false; //Assume quantities are valid in the beginning
      total_qty = 0; //Need to check if something was selected so we will look if the total > 0
      for (i = 0; i < products_array[this_product_key].length; i++) {
        if (params.has(`quantity${i}`)) {
        //Taken and modified from lab11, exercise 4 for making quantity entries sticky
          a_qty = params.get(`quantity${i}`);
          product_order[`quantity${i}`].value = a_qty;
          total_qty += a_qty;
            if (!IsNonNegInt(a_qty)) {
              has_errors = true; 
              checkQuantityTextbox(product_order[`quantity${i}`]); //show where the error is
            }
            if (a_qty > products_array[this_product_key][i]['quantity_available']){
              stock_error = true;
            }
        }
        if (has_errors) { // Input quantity has errors.
          alert("Please enter only valid quantities!"); // Alert to enter valid quantities
            return false;
        } else if (total_qty == 0) { // Input quantity is either 0 or nothing.
          alert("Please enter some quantities!"); // Alert to enter quantities if textboxes are empty
            return false;
        } else if (stock_error){ // Input quantity is greater than the amount of available quantities of a product/products.
          alert("Out of Stock"); // Alert that items are out of stock
            return false;
        } else {
          window.location = `./invoice.html${document.location.search}`;
          window.stop;
        };
      };
    };
  };
</script>
<br>
<br>

<form name="product_order" action="/gotocart" method="POST">
  <div class="container">    
    <div class="row">
      <div class="col-sm-4">
        <div class="panel panel-primary">
          <div class="panel-body">
            <script>
            products = products_array[this_product_key];
              document.write(`<input type="hidden" name="this_product_key" value="${this_product_key}">`);
              for (i = 0; i < products.length * 1/3; i++){ // loops through and displays the 1st and 2nd products individually

              // Variable created to get ratings and make the average of all the reviews. Asked Professor Port for help on this
              var stars = (products[i].stars.reduce((a, b) => a + b, 0) / products[i].stars.length).toFixed(0);
                document.write(`
                    <h2>${products[i]['name']}</h2> <!-- displays product name -->
                    <img src="${products[i]['image']}"> <!-- displays product image -->
                    <h3><b>$${products[i]['price'].toFixed(2)}</b></h3> <!-- displays product price -->
                    <h4><b>Stock:${products[i]['quantity_available']}<b></h4> <!-- displays quantity available -->
                    <label id="quantity${i}_label"><h4><b>Quantity<b></h4></label>
                    <input type='text' min='0' placeholder='0' id="quantity${i}" name="quantity${i}" onkeyup="checkQuantityTextbox(this);"> <!-- displays client order box --> 
                `)
                // Borrowed and edited from Progga Ilma on https://stackoverflow.com/questions/53240610/how-to-make-simple-star-rating. Displays the number of filled stars based on the average calculated above. Starting number of stars is the starss products_json. Copied and pasted this for the rest of the tables below. Also makes it so that stars can't be edited
                document.write( `<div class="star-rating">`) 
                              if (stars == 5){
                                document.write(`<s class="active"></s><s class="active"></s><s class="active"></s><s class="active"></s><s class="active"></s>`)}
                              if (stars == 4){
                                document.write(`<s class="active"></s><s class="active"></s><s class="active"></s><s class="active"></s><s></s>`)}
                              if (stars == 3){
                                document.write(`<s class="active"></s><s class="active"></s><s class="active"></s><s></s><s></s>`)}
                              if (stars == 2){
                                document.write(`<s class="active"></s><s class="active"></s><s></s><s></s><s></s>`)}
                              if (stars == 1){
                                document.write(`<s class="active"></s><s></s><s></s><s></s><s></s>`)}
                          //Writes out how many reviews there have been for the item so far
                          document.write (`<br> ${products[i].stars.length} Reviews so far
                          </div>`)
                            }
            </script>
              
          </div>
        </div>
      </div>
      <div class="col-sm-4"> 
        <div class="panel panel-primary">
          <div class="panel-body">
            <script>
               products = products_array[this_product_key];
              for (i = products.length * 1/3; i < products.length * 2/3; i++){ // loops through and displays the 3rd and 4th products individually
                var stars = (products[i].stars.reduce((a, b) => a + b, 0) / products[i].stars.length).toFixed(0);
                document.write(`
                    <h2>${products[i]['name']}</h2> <!-- displays product name -->
                    <img src="${products[i]['image']}"> <!-- displays product image -->
                    <h3><b>$${products[i]['price'].toFixed(2)}</b></h3> <!-- displays product price -->
                    <h4><b>Stock:${products[i]['quantity_available']}<b></h4> <!-- displays quantity available -->
                    <label id="quantity${i}_label"><h4><b>Quantity<b></h4></label>
                    <input type='text' min='0' placeholder='0' id="quantity${i}" name="quantity${i}" onkeyup="checkQuantityTextbox(this);"> <!-- displays client order box --> 
                `)
                document.write( `<div class="star-rating">`) 
                              if (stars == 5){
                                document.write(`<s class="active"></s><s class="active"></s><s class="active"></s><s class="active"></s><s class="active"></s>`)}
                              if (stars == 4){
                                document.write(`<s class="active"></s><s class="active"></s><s class="active"></s><s class="active"></s><s></s>`)}
                              if (stars == 3){
                                document.write(`<s class="active"></s><s class="active"></s><s class="active"></s><s></s><s></s>`)}
                              if (stars == 2){
                                document.write(`<s class="active"></s><s class="active"></s><s></s><s></s><s></s>`)}
                              if (stars == 1){
                                document.write(`<s class="active"></s><s></s><s></s><s></s><s></s>`)}
                          //Writes out how many reviews the item
                          document.write (`<br>${products[i].stars.length} Reviews so far
                          </div>`)
                            }
            </script>
          </div>
        </div>
      </div>
      <div class="col-sm-4"> 
        <div class="panel panel-primary">
          <div class="panel-body">
            <script>
              for (i = products.length * 2/3; i < products.length; i++){ // loops through and displays the 3rd and 4th products individually
                var stars = (products[i].stars.reduce((a, b) => a + b, 0) / products[i].stars.length).toFixed(0);
                document.write(`
                    <h2>${products[i]['name']}</h2> <!-- displays product name -->
                    <img src="${products[i]['image']}"> <!-- displays product image -->
                    <h3><b>$${products[i]['price'].toFixed(2)}</b></h3> <!-- displays product price -->
                    <h4><b>Stock:${products[i]['quantity_available']}<b></h4> <!-- displays quantity available -->
                    <label id="quantity${i}_label"><h4><b>Quantity<b></h4></label>
                    <input type='text' min='0' placeholder='0' id="quantity${i}" name="quantity${i}" onkeyup="checkQuantityTextbox(this);"> <!-- displays client order box --> 
                `)
                document.write( `<div class="star-rating">`) 
                              if (stars == 5){
                                document.write(`<s class="active"></s><s class="active"></s><s class="active"></s><s class="active"></s><s class="active"></s>`)}
                              if (stars == 4){
                                document.write(`<s class="active"></s><s class="active"></s><s class="active"></s><s class="active"></s><s></s>`)}
                              if (stars == 3){
                                document.write(`<s class="active"></s><s class="active"></s><s class="active"></s><s></s><s></s>`)}
                              if (stars == 2){
                                document.write(`<s class="active"></s><s class="active"></s><s></s><s></s><s></s>`)}
                              if (stars == 1){
                                document.write(`<s class="active"></s><s></s><s></s><s></s><s></s>`)}
                          //Writes out how many reviews the item
                          document.write (`<br>${products[i].stars.length} Reviews so far
                          </div>`)
                            }
            </script>
          </div>
        </div>
      </div>
    </div>
  </div>
</form>
<br>
<br>
<!-- Taken and modified from Anthony (Wonjoon) Lee's code for resetting values -->
<div class = "submission">
  <input type="submit" value="Add to Cart" name="purchase_submit">
  <input type="button" value="Reset Values" onclick="
    for (i = 0; i < products.length; i++) {
      document.getElementById(`quantity${i}`).value = 0;
      }; alert('All Values Reset!');
  ">
</div>
</body>
</html>
<br>
<br>
<br>
<br>
<br>

<!-- The following code is a part of the model layout on W3Schools at https://www.w3schools.com/bootstrap/tryit.asp?filename=trybs_temp_store&stacked=h -->
<!-- I also modified this code by adding a trade mark, my name, store name and year and bolding the "Sign Up" text.-->
<a style="text-decoration: none;">
  <footer class="container-fluid2 text-center">
  <p>
    <b><span>&#169;</span>Zenan's Sport's Shop 2022</b>
  </p>  
    <form class="form-inline"><b>Get deals:</b>
      <input type="email" class="form-control" size="50" placeholder="Email Address">
      <button type="button" class="btn btn-danger"><b>Sign Up</b></button>
    </form>
  </footer>
</a>

<script>
  if (params.has("msg")) {
    alert(params.get("msg"));
  }
</script>
