<!--- Description 
Author: Zenan Li & Kai Lin
Date: May 13th, 2022
Description: This is the invoice page/shopping cart page to display an invoice of the products that have been added to the to shopping cart. On this page they can see an invoice based on what is currently in their cart. They are also able to finalze the quantites they want to order and then can sign in to be redirected to purchase.html
----->
<!DOCTYPE html>
<html lang="en">

<head>
  <title>Your Receipt</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js"></script>
  <link rel="stylesheet" href="./invoice_style.css">
  <style>
    /* Remove the navbar's default rounded borders and increase the bottom margin */
    .navbar {
      margin-bottom: 50px;
      border-radius: 0;
      overflow: hidden;
      font-family: Arial, Helvetica, sans-serif;
    }

    .navbar a {
    float: left;
    color: white;
    text-align: center;
    text-decoration: none;
    }

    /* Remove the jumbotron's default bottom margin */
    .jumbotron {
      margin-bottom: 0;
    }

    /* Add a gray background color and some padding to the footer */
    footer {
      background-color: #f2f2f2;
      padding: 25px;
    }
  </style>

  <script>
    //get quantities from querystring
    let params = (new URL(document.location)).searchParams
  </script>
</head>

<script src="./functions.js"></script>
<script>
 //Variable for the User Info to display user's name
  var uinfo;
  loadJSON('get_user_info', function (response) {
    // Parsing JSON string into object
    uinfo = JSON.parse(response);
  });

//Variables for Nav Bar
var this_product_key = loadJSON('products_key');

var products_array;
loadJSON('get_products_data', function(response) {
  // Parsing JSON string into object
  products_array = JSON.parse(response);
});

 //Variable for the # of total items in cart
var cart_amount;
    loadJSON('./get_cart_data', function (response) {
        // Parsing JSON string into object
        cart_amount = JSON.parse(response);
    });
</script>

<body1>
  <div class="jumbotron">
    <div class="container1 - text-center">
      <h1>Zenan's Sport's Shop</h1>
      <p>Mission, Vision & Values</p>
    </div>
  </div>
  <!-- Start of the Nav Bar-->
  <nav class="navbar navbar-inverse">
    <div class="container-fluid1">
      <div class="collapse navbar-collapse" id="myNavbar">
        <ul class="nav navbar-nav">
          <li><a href="index.html">Home</a></li>
          <!-- Displays the different products pages-->
            <script>
              nav_bar(this_product_key, products_array);
            </script>
          <li><a href="contact.html">Contact</a></li>
        </ul>
        <ul class="nav navbar-nav navbar-right">
          <!--Displays Sign in page if the user is logged in or logout button with their name is signed in -->
          <script>
            if (uinfo.username == "Your Account")
            document.write(`<li><a href="login.html"><span class="glyphicon glyphicon-user"></span>Sign In</a></li>`)
  
            else
              document.write(`
              <li><a href="/logout"> <span class="glyphicon glyphicon-user"></span>Logout ${uinfo.username}</a></li>
              `);
          </script>
          <li><a href="update.html"><span class="glyphicon glyphicon-user"></span>Update Acccount</a></li>
          <li><a href="register.html"><span class="glyphicon glyphicon-user"></span>Register</a></li>
          <!-- Links to the shopping cart page but also displays a shopping cat image with total number of items in the cart -->
          <li><a href="invoice.html"><span class="glyphicon glyphicon-shopping-cart"></span>Cart(<script>document.write(cart_total(cart_amount))</script>)</a>
        </ul>
      </div>
    </div>
  </nav>
  
    <body>
      <div class="value_validation">
        <!-- Start of form to update the amounts in the cart-->
        <form action="/updatecart" method="POST">
      </div>
      <br>
      <div class="container">
        <div class="row gutters">
          <div class="col-xl-12 col-lg-12 col-md-12 col-sm-12 col-12">
            <div class="card">
              <div class="card-body p-0">
                <div class="invoice-container">
                  <div class="invoice-header">
                    <!-- Row start -->
                    <div class="invoice-body">
                      <!-- Row start -->
                      <div class="row gutters">
                        <div class="col-lg-12 col-md-12 col-sm-12">
                          <div class="table-responsive">
                            <table class="table custom-table m-0">
                              <thead>
                                <tr>
                                  <th>Product</th>
                                  <th>Quantity</th>
                                  <th>Unit Price</th>
                                  <th>Extended Price</th>
                                </tr>
                              </thead>
                              <tbody>
                                <tr>
                                  <script>
                                    var subtotal = 0; // subtotal price
                                    // create quantities variable
                                    var quantities = [];
                                    // Go through items in cart
                                    for (let this_product_key in cart_amount) {
                                      quantities = cart_amount[this_product_key];
                                      for (let i in quantities) { // loops through all products to output product info of the purchased product(s)
                                          var extended_price = products_array[this_product_key][i]['price'] * quantities[i];
                                          subtotal = subtotal + extended_price;
                                          if (quantities[i] != 0) {
                                            document.write(`
                                                                <tr>
                                                                <td>${products_array[this_product_key][i]['name']}</td>

                                                                <td><input type="number" name="cart_update[${this_product_key}][${i}]" value="${quantities[i]}" min="0" max="${products_array[this_product_key][i]['quantity_available']}"</td>

                                                                <td>$${products_array[this_product_key][i]['price'].toFixed(2)}</td>

                                                                <td>$${(products_array[this_product_key][i]['price'] * quantities[i]).toFixed(2)}
                                                                </tr>
                                                                `);
                                          } else {
                                            document.write(`<input type="hidden" name="cart_update[${this_product_key}][${i}]" value="0">`)
                                          }
                                        }
                                      }
                                  </script>
                                </tr>
                                <tr>
                                  <td colspan="2">
                                    <p>
                                      <script>
                  var shipping = 0; // shipping
                  if (subtotal < 99.99) { // subtotal if less than $99.99
                    shipping = 5;
                  } else if (subtotal >= 100 && subtotal < 199.99) { // subtotal if less than $199.99 and over $100
                    shipping = 8;
                  } else if (subtotal >= 200) { // subtotal if greater than or equal to $200
                    shipping = subtotal * 0.05;
                  }
                  var tax = (subtotal * 0.04712); // tax
                  var total = (subtotal + shipping + tax) // calculating grand total
                  document.write(`
                                                                            <tr>
                                                                                <td colspan='3'>Subtotal</td>
                                                                                <td>$${subtotal.toFixed(2)}</td>
                                                                            </tr>
                                                                            <tr>
                                                                                <td colspan='3'>Tax (4.712%)</td>
                                                                                <td>$${tax.toFixed(2)}</td>
                                                                            </tr>
                                                                            <tr>
                                                                                <td colspan='3'>Shipping</td>
                                                                                <td>$${shipping.toFixed(2)}</td>
                                                                            </tr>
                                                                            <tr>
                                                                            <th colspan='3'>Total</th>
                                                                                 <td>$${total.toFixed(2)}</td>    
                                                                            </tr>
                                                                            `)
                                      </script>
                              </tbody>
                            </table>
                          </div>
                        </div>
                      </div>
                      <!-- Row end -->
                    </div>
                    <div class="update_cart">
    
                  <input type="submit" value="Update Cart"  name="update_cart_button">

                    </div>
  </form>
  <div class="invoice-footer">
    <h3><b>
        <p>Our Shipping Policy:</p>
      </b></h3>
    <h4>
      <p>$0 - $99.99: $5.00</p>
    </h4>
    <h4>
      <p>$100.00 - $199.99: $8.00</p>
    </h4>
    <h4>
      <p>$200.00+: 5% of subtotal</p>
    </h4>
    <br>
    <!--LOGIN TO finalize their order -->
    <div class="final_purchase">
    <form id = "login_checkout" action = "" method = "POST">
    <!-- Calls function to check that invoice is logged and does not have 0 items in their cart -->
      <input type="button" onclick= "checkinvoice()"  value="Please Log In To Order">
      
    </form>
    </div>

    <!--Personalized THANK YOU MESSAGE FOR USER-->
    <script>
      if (uinfo.username == "Your Account")
      document.write (`<h3>Please Log In To Purchase!</h3>`)

      else
          document.write(`<h3>Thank you ${uinfo.username} for signing in! If you accept the terms and price <br> please click "Complete Purchase" above </h3>`)
    </script>
  </div>
  <br>
  <div class="notice">
    <h4>Note: Shipment is expected to arrive within 7 to 14 days; please save a copy of this invoice and present it to
      the mailman when the shipment arrives at your doorstep!</h4>
  </div>
  <br>
  <br>
  </div>
  <!--End InvoiceBot-->
  </div>
  <!--End Invoice-->
  </div>
  </div>
  </div>
  </div>
  </div>
  </div>
  </div>
  </div>
  </body>
</body1>

</html>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>

<footer class="container-fluid2 text-center">
  <p>
    <b><span>&#169;</span>Zenan's Sport's Shop 2022</b>
  </p>
  <form class="form-inline"><b>Get deals:</b>
    <input type="email" class="form-control" size="50" placeholder="Email Address">
    <button type="button" class="btn btn-danger"><b>Sign Up</b></button>
  </form>
</footer>
