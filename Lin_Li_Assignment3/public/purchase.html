<!--- Description 
Author: Zenan Li & Kai Lin
Date: April 17th, 2022
Description: This is the Purchase page where the finalized quantities can be purchased. When purchased the user receives an email, the quantity available is updated and then the session is destroyed. The user can also rate the product on this page on a scale of 1-5 stars if they choose to.
----->

<script src="./functions.js"></script>
<script>
    //Variable for the User Info to display user's name
  var uinfo;
  loadJSON('get_user_info', function (response) {
    // Parsing JSON string into object
    uinfo = JSON.parse(response);
    // if user is not logged in, bounce them to login
    if (uinfo.username == 'Your Account') {
        location.href = "./login.html";
    }
  });

//Variables for Nav Bar
var this_product_key = loadJSON('products_key');

var products_array;
loadJSON('get_products_data', function(response) {
  // Parsing JSON string into object
  products_array = JSON.parse(response);
});

//Variable for the # of total items in cart
var cart_amount;
    loadJSON('./get_cart_data', function (response) {
        // Parsing JSON string into object
        cart_amount = JSON.parse(response);
    });
</script>

<!DOCTYPE html>
<html lang="en">

<head>
  <title>Your Receipt</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js"></script>
  <link rel="stylesheet" href="./invoice_style.css">
  <style>
    /* Remove the navbar's default rounded borders and increase the bottom margin */
    .navbar {
      margin-bottom: 50px;
      border-radius: 0;
      overflow: hidden;
      font-family: Arial, Helvetica, sans-serif;
    }

    .navbar a {
    float: left;
    color: white;
    text-align: center;
    text-decoration: none;
    }

    /* Remove the jumbotron's default bottom margin */
    .jumbotron {
      margin-bottom: 0;
    }

    /* Add a gray background color and some padding to the footer */
    footer {
      background-color: #f2f2f2;
      padding: 25px;
    }

    /* Styling for the rating stars on the table. This styling code was borrowed and edited from https://stackoverflow.com/questions/53240610/how-to-make-simple-star-rating */
    .stars s:hover,
    .stars s.active {
      color: yellow;
    }

    .star-rating-rtl s:hover,
    .star-rating-rtl s.active {
      color: yellow;
    }
    .star-rating-rtl {
    background: rgb(0, 0, 0);
    display: inline-block;
    }
  .star-rating-rtl s {
    color: yellow;
  } 
    .star-rating s,
    .star-rating-rtl s {
      color: rgb(249, 220, 59);
      font-size: 40px;
      cursor: default;
      text-decoration: none;
      line-height: 40px;
      text-align: center;
    }

    .star-rating s.rated:before,
    .star-rating s.active:before {
        content: "\2605";
    }
    .star-rating s:before {
        content: "\2606";
    }
    .star-rating-rtl s.rated:after,
    .star-rating-rtl s.active:after {
        content: "\2605";
    }

    .star-rating-rtl s:after {
        content: "\2606";
    }
  </style>
</head>

<body1>
  <div class="jumbotron">
    <div class="container1 - text-center">
      <h1>Zenan's Sport's Shop</h1>
      <p>Mission, Vision & Values</p>
    </div>
  </div>
  <!-- Start of the Nav Bar-->
  <nav class="navbar navbar-inverse">
    <div class="container-fluid1">
      <div class="collapse navbar-collapse" id="myNavbar">
        <ul class="nav navbar-nav">
          <li><a href="index.html">Home</a></li>
          <!-- Displays the different products pages-->
            <script>
              nav_bar(this_product_key, products_array);
            </script>
          <li><a href="contact.html">Contact</a></li>
        </ul>
        <ul class="nav navbar-nav navbar-right">
            <!--Displays Sign in page if the user is logged in or logout button with their name is signed in -->
          <script>
            if (uinfo.username == "Your Account")
            document.write(`<li><a href="login.html"><span class="glyphicon glyphicon-user"></span>Sign In</a></li>`)
  
            else
              document.write(`
              <li><a href="/logout"> <span class="glyphicon glyphicon-user"></span>Logout ${uinfo.username}</a></li>
              `);
          </script>
          <li><a href="update.html"><span class="glyphicon glyphicon-user"></span>Update Acccount</a></li>
          <li><a href="register.html"><span class="glyphicon glyphicon-user"></span>Register</a></li>
           <!-- Links to the shopping cart page but also displays a shopping cat image with total number of items in the cart -->
          <li><a href="invoice.html"><span class="glyphicon glyphicon-shopping-cart"></span>Cart(<script>document.write(cart_total(cart_amount))</script>)</a>)a>
        </ul>
      </div>
    </div>
  </nav>
  
    <body>
      <div class="value_validation">
           <!-- Start of form to review the products-->
           <form id="final_purchase" action="/finalize_purchase"  method="POST">
      </div>
      <br>
      <div class="container">
        <div class="row gutters">
          <div class="col-xl-12 col-lg-12 col-md-12 col-sm-12 col-12">
            <div class="card">
              <div class="card-body p-0">
                <div class="invoice-container">
                  <div class="invoice-header">
                    <!-- Row start -->
                    <div class="invoice-body">
                      <!-- Row start -->
                      <div class="row gutters">
                        <div class="col-lg-12 col-md-12 col-sm-12">
                          <div class="table-responsive">
                            <table class="table custom-table m-0">
                              <thead>
                                <tr>
                                  <th>Product</th>
                                  <th>Quantity</th>
                                  <th>Unit Price</th>
                                  <th>Extended Price</th>
                                  <th>Rating</th>
                                </tr>
                              </thead>
                              <tbody>
                                <tr>
                                  <script>
                                    var subtotal = 0; // subtotal price
                                    // create quantities variable
                                    var quantities = [];
                                    // go through items in cart
                                    for (let this_product_key in cart_amount) {
                                      quantities = cart_amount[this_product_key];
                                      for (let i in quantities) { // loops through all products to output product info of the purchased product(s)
                                          var extended_price = products_array[this_product_key][i]['price'] * quantities[i];
                                          subtotal = subtotal + extended_price;
                                          if (quantities[i] != 0) {
                                            document.write(`
                                                                <tr>
                                                                <td>${products_array[this_product_key][i]['name']}</td>

                                                                <td>${quantities[i]}</td>

                                                                <td>$${products_array[this_product_key][i]['price'].toFixed(2)}</td>

                                                                <td>$${(products_array[this_product_key][i]['price'] * quantities[i]).toFixed(2)}</td>
                                                                  
                                                                <td> <div id="stars_${this_product_key}_${i}" class="star-rating"><s><s><s><s><s></s></s></s></s></s> 
                                                                  <input class="star_data" type="hidden" name="reviews[${this_product_key}][${i}]" value="">
                                                                  </div>
                                                                
                                                                  </tr>
                                                                
                                                                `);
                                                                //The last row displays 5 empty stars that can be selected for the user to rate the producuts
                                          }
                                        }
                                      }
                                  </script>
                                </tr>
                                <tr>
                                  <td colspan="2">
                                    <p>
                                      <script>
                  var shipping = 0; // shipping
                  if (subtotal < 99.99) { // subtotal if less than $99.99
                    shipping = 5;
                  } else if (subtotal >= 100 && subtotal < 199.99) { // subtotal if less than $199.99 and over $100
                    shipping = 8;
                  } else if (subtotal >= 200) { // subtotal if greater than or equal to $200
                    shipping = subtotal * 0.05;
                  }
                  var tax = (subtotal * 0.04712); // tax
                  var total = (subtotal + shipping + tax) // calculating grand total
                  document.write(`
                                                                            <tr>
                                                                                <td colspan='3'>Subtotal</td>
                                                                                <td>$${subtotal.toFixed(2)}</td>
                                                                            </tr>
                                                                            <tr>
                                                                                <td colspan='3'>Tax (4.712%)</td>
                                                                                <td>$${tax.toFixed(2)}</td>
                                                                            </tr>
                                                                            <tr>
                                                                                <td colspan='3'>Shipping</td>
                                                                                <td>$${shipping.toFixed(2)}</td>
                                                                            </tr>
                                                                            <tr>
                                                                            <th colspan='3'>Total</th>
                                                                                 <td>$${total.toFixed(2)}</td>    
                                                                            </tr>
                                                                            `)
                                      </script>
                              </tbody>
                            </table>
                          </div>
                        </div>
                      </div>
                      <!-- Row end -->
                    </div>
                    <div class="update_cart">
                    <!--Button where people submit their star ratings for the products-->
                  

                    </div>
  
  <div class="invoice-footer">
    <h3><b>
        <p>Our Shipping Policy:</p>
      </b></h3>
    <h4>
      <p>$0 - $99.99: $5.00</p>
    </h4>
    <h4>
      <p>$100.00 - $199.99: $8.00</p>
    </h4>
    <h4>
      <p>$200.00+: 5% of subtotal</p>
    </h4>
    <br>
    <!--BUTTON to finalize purchase which will then send them an invoice to the user's email, update the inventory, and destroy the session which will log them out and then redirect them to their last page -->
    <div class="final_purchase">
      
  <!--User should be logged in which allows them complete purchase-->
  <script>
      if (uinfo.username != "Your Account")
      document.write(`
        <div class ="final_purchase">
        <input type="submit"  value= "Complete Purchase">`);
    </script>
    </form>
    </div>
    <!--THANK YOU MESSAGE FOR USER-->
    <script>
      if (uinfo.username != "Your Account")
          document.write(`<h3>Thank you ${uinfo.username} for shopping with us! <br><br> If you are happy with order shown above please click the above button to complete the purchase. Afterwards, an invoice of your purchase will be sent to your email, your cart will be emptied and you will be logged out!   </h3>`)
 
 </script>
    <!-- Variable to make so that the user can select the amount of stars they want to give the prodcut. This was borrowed and edited code from a user named "caramba" on https://stackoverflow.com/questions/44462321/star-rating-system-save-value-on-click also got help editing the code from professor port. Copying this from online made it harder-->
    <script>
    
      $(function () {
        $("div.star-rating > s, div.star-rating-rtl > s").on("click", function (e) {
        
          // Gets rid of all of the active classes first which is needed tf the user clicks multiple times 
          $(this).closest('div').find('.active').removeClass('active');

          // All of the elements excluding the self that are clicked o
          $(e.target).parentsUntil("div").addClass('active');

          //Element user had clicjed on will be added 
          $(e.target).addClass('active');  // the element user has clicked on

          var stars = $(e.target).parentsUntil("div").length + 1;
          $(this).parent().find(".star_data").val(stars)
          console.log($(this).parent().find(".star_data").val())
        });
      });
      </script>
  </div>
  <br>
  <div class="notice">
    <h4>Note: Shipment is expected to arrive within 7 to 14 days; please save a copy of this invoice and present it to
      the mailman when the shipment arrives at your doorstep!</h4>
  </div>
  <br>
  <br>
  </div>
  <!--End InvoiceBot-->
  </div>
  <!--End Invoice-->
  </div>
  </div>
  </div>
  </div>
  </div>
  </div>
  </div>
  </div>
  </body>
</body1>

</html>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>

<footer class="container-fluid2 text-center">
  <p>
    <b><span>&#169;</span>Zenan's Sport's Shop 2022</b>
  </p>
  <form class="form-inline"><b>Get deals:</b>
    <input type="email" class="form-control" size="50" placeholder="Email Address">
    <button type="button" class="btn btn-danger"><b>Sign Up</b></button>
  </form>
</footer>

<script>
  if (params.has("msg")) {
    alert(params.get("msg"));
  }
</script>


var ref_URL = new URL(request.get('Referrer'))
console.log("123", ref_URL)
if (typeof ref_URL == "undefined") {ref_URL = '/index.html';}
else {response.redirect(ref_URL)}