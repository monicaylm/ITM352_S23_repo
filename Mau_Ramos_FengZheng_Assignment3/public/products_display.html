<!-- Authors: Monica Mau, Le Yi Feng Zheng, Brandon Ramos -->
<!-- Assignment 3 -->
<!-- Date: 5/12/2023 -->
<!-- Products Display Page -->

<!DOCTYPE html>
<html lang="en">

<head>
    <!-- Products Data -->
    <script src="./products_data.js" type="text/javascript"></script>
    <link href="products-style.css" rel="stylesheet">

    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Quicksand" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Comfortaa" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@700&family=Varela+Round&display=swap"
        rel="stylesheet">

    <!-- Shopping Cart Icon Source -->
    <script src='https://kit.fontawesome.com/a076d05399.js' crossorigin='anonymous'></script>

    <script>
        // get querystring data
        var params = (new URL(document.location)).searchParams;

        //search for product key to display on navigation
        if (params.has('product_type')) {
            var product_type = params.get('product_type');
        } else {
            response.redirect(`./products_display.html?${params.toString()}`);
            window.stop;
        }

        // execute async function when on window load // assisted by prof port
        window.onload = async function () {
            await getcart();
            // put items in cart back into textboxes
            if (cart.hasOwnProperty(product_type)) {
                for (let i in cart[product_type]) {
                    qtyForm[`quantity${i}`].value = cart[product_type][i];
                }
            }

            // define variable to represent qty sold
            var sold = JSON.parse(params.get("amountSold"));
    /*
            // if errors, go get errors and quantities and display them
            if (params.has("errorsJSONstring")) {
                var errorsObject = JSON.parse(params.get("errorsJSONstring"));
                // check if there are no selections
                if (typeof errorsObject["noQty"] != "undefined") {
                    // IR 4: If the purchase is invalid change the purchase button text from “Purchase” to text that indicates why the purchase is invalid (no quantities selected)
                    document.getElementById('purchase_button').value = errorsObject["noQty"];
                } else {
                    // alert if any errors
                    //alert('Invalid quantities!')
                    // put quantities back in textboxes 
                    for (i = 0; i < products[product_type].length; i++) {
                        qtyForm[`quantity${i}`].value = params.get(`quantity${i}`);

                        // handle invalid quantity
                        if (typeof errorsObject[`quantity${i}_error`] != "undefined") {

                            // display specific quantity error by textbox   
                            document.getElementById(`quantity${i}_errors_span`).innerHTML = errorsObject[`quantity${i}_error`];

                            // IR 4: If the purchase is invalid change the purchase button text from “Purchase” to text that indicates why the purchase is invalid (invalid quantity, not a non-neg integer)
                            document.getElementById('purchase_button').value = 'Invalid quantity!';
                        }
                        // handle qty not available 
                        else if (typeof errorsObject[`quantity${i}_available_error`] != "undefined") {

                            // display specific quantity error by textbox   
                            document.getElementById(`quantity${i}_errors_span`).innerHTML = errorsObject[`quantity${i}_available_error`];

                            // IR 4: If the purchase is invalid change the purchase button text from “Purchase” to text that indicates why the purchase is invalid (quantity unavailable)    
                            document.getElementById('purchase_button').value = 'Quantity unavailable!';

                            // IR 3: set textbox value to quantity available if requested quantity is greater than available and make textbox red 
                            qtyForm[`quantity${i}`].value = products[product_type][i].quantity_available;
                            qtyForm[`quantity${i}`].style.border = "2px solid red";
                            qtyForm[`quantity${i}`].style.borderRadius = "5px";


                        }
                    }
                }
            }
        */
        }

        // Search feature 
        //function searchInput() {}

        // Add to Favorites button (not working)
        function favorite(prod_index) {
            var favoriteBtn = document.getElementById(`favoritebtn`);
            if(favoriteBtn.style.color == 'red') {
                favoriteBtn.style.color = 'grey';
            } else {
                favoriteBtn.style.color = 'red';
            }
        }
    </script>

    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SHINee Album Shop</title>

</head>

<h1>SHINee Album Shop</h1>
<div class="searchBar">
    <input type="text" id="searchInput" onkeyup="searchInput()" placeholder="Search for album..." title="Type in Album name">
</div>
<!--Nav bar-->
<div class="navbar">
    <img src="./images/logo.png" class="logo">
    <script>
        for (let key in products) {
            document.write(`<li style="list-style-type: none;"><a href="./products_display.html?product_type=${key}">${key}</a></li>
            `);
        }
    </script>
    
    <div class="login">
        <a onclick="window.location.href = 'login.html'">Login</a>
    </div>
</div>
<div class="cart_icon">
    <a href="./cart.html">
        <i class='fas fa-shopping-cart'></i>
    </a>
</div>
<div class="admin" id="adminBtn">
    <a href="./admin">ADMIN
    </a>
</div>


<body>
    <form id="qtyForm">
        <div class="products">
            <main class="container">
                <script>
                    // product_key as a hidden input so server can get products quantity
                    document.write(`<input type="hidden" name="product_type" value="${product_type}">`);
                </script>

                <script>
                    // loops through products array to display product information

                    for (i = 0; i < products[product_type].length; i++) {
                        document.write(`
                        <section class="item">
                        <h2>${products[product_type][i].name}</h2>
                        <img src ="./images/${products[product_type][i].image}">
                        <div class="details">
                        <p>&dollar;${products[product_type][i].price}</p>
                        <h3>In stock: ${products[product_type][i].quantity_available}<br>&#9671;<br>Sold: ${products[product_type][i].quantity_sold}</h3>
                        <div class="qty">
                        <label id="quantity${i}_label">Quantity:</label><input type="text" id="quantity${i}_id" placeholder="0" name="quantity${i}">
                        </div>
                        <br>
                        <span class="errors-span" id="quantity${i}_errors_span"></span>
                        </div> <br>
                        <div class="likeBtn">
                            <Button onclick='favorite(${i})' id="favoritebtn" class="favoritebtn"><i class="fas fa-heart"></i></Button>
                        </div>
                        <input type="button" onclick='addToCart(${i});' class="purchase_button" id="purchase_button" value="Add to cart">
                        </section>
                     `)
                    }
                </script>
            </main>
        </div>

        <!-- copyright -->
        <footer>
            &copy; 2023 Monica's SHINee Album Shop
        </footer>

        <!-- cart microservice assisted by Prof Port -->
        <script>
            // empty cart variable
            var cart;
            // get users cart data
            async function getcart() {
                try {
                    const response = await fetch("./get_cart", {
                        method: "POST", // or 'PUT'
                        headers: {
                            "Content-Type": "application/json",
                        }
                    });

                    cart = await response.json();
                    console.log("Success:", cart);

                } catch (error) {
                    console.error("Error:", error);
                }
            }

            async function addToCart(prod_index) {
                var quantity = document.getElementById(`quantity${prod_index}_id`).value
                var data = { 'prod_type': product_type, 'product_index': prod_index, 'prod_quantity': quantity };
                console.log('adding to cart', data)
                try {
                    const response = await fetch("./addToCart", {
                        method: "POST", // or 'PUT'
                        headers: {
                            "Content-Type": "application/json",
                        },
                        body: JSON.stringify(data),
                    });

                    const errorsObject = await response.json();
                    console.log("Success:", errorsObject);

                    if (Object.keys(errorsObject).length === 0) {
                        getcart();
                        document.getElementById(`quantity${prod_index}_errors_span`).innerHTML = "";
                        qtyForm[`quantity${prod_index}`].style.border = "1px solid black";
                        qtyForm[`quantity${prod_index}`].style.borderRadius = "2px";
                        qtyForm[`quantity${prod_index}`].value = "";

                        // alert that products have been added to the cart
                        alert(`You have added ${quantity} ${products[product_type][prod_index].name} album(s) to your shopping cart!`);
                    } else {
                        // handle invalid quantity
                        if (typeof errorsObject[`quantity${prod_index}_error`] != "undefined") {

                            // display specific quantity error by textbox   
                            document.getElementById(`quantity${prod_index}_errors_span`).innerHTML = errorsObject[`quantity${prod_index}_error`];
                        }
                        // handle qty not available 
                        else if (typeof errorsObject[`quantity${prod_index}_available_error`] != "undefined") {

                            // display specific quantity error by textbox   
                            document.getElementById(`quantity${prod_index}_errors_span`).innerHTML = errorsObject[`quantity${prod_index}_available_error`];

                            // IR 3: set textbox value to quantity available if requested quantity is greater than available and make textbox red 
                            qtyForm[`quantity${prod_index}`].value = products[product_type][prod_index].quantity_available;
                            qtyForm[`quantity${prod_index}`].style.border = "2px solid red";
                            qtyForm[`quantity${prod_index}`].style.borderRadius = "3px";

                        }
                    }

                } catch (error) {
                    console.error("Error:", error);
                }
            }
        </script>
</body>
</form>

</html>